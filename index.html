<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema de Catequese</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
:root{
  --primary:#4CAF50;
  --primary-dark:#3d8b41;
  --bg:#f4f6f9;
  --card-bg:#fff;
  --text:#333;
  --success:#d4edda;
  --success-text:#155724;
}
*{margin:0;padding:0;box-sizing:border-box;font-family:'Poppins',sans-serif;}
body{display:flex;background:var(--bg);color:var(--text);}
nav{
  width:220px;background:var(--primary);color:white;min-height:100vh;
  display:flex;flex-direction:column;padding:20px 10px;position:fixed;
}
nav h1{text-align:center;font-size:20px;margin-bottom:30px;font-weight:600;}
nav button{
  background:none;border:none;color:white;padding:12px;margin:5px 0;text-align:left;
  cursor:pointer;border-radius:8px;font-size:15px;display:flex;align-items:center;gap:10px;transition:0.3s;
}
nav button:hover, nav button.active{background:var(--primary-dark);}
main{margin-left:220px;padding:30px;width:100%;overflow-x:auto;}
section{display:none;animation:fadeIn 0.3s ease;}
section.active{display:block;}
@keyframes fadeIn{from{opacity:0;transform:translateY(10px);}to{opacity:1;transform:translateY(0);}}
h2{margin-bottom:20px;font-weight:600;}
.card{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:25px;transition:0.3s;}
.card:hover{transform:translateY(-2px);}
.form-group{margin-bottom:15px;}
.form-group label{display:block;margin-bottom:6px;font-size:14px;font-weight:600;}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px;border:1px solid #ccc;border-radius:8px;font-size:14px;}
textarea{resize:none;}
.btn{background:var(--primary);color:white;padding:10px 16px;border:none;border-radius:8px;cursor:pointer;font-size:14px;transition:0.3s;}
.btn:hover{background:var(--primary-dark);}
table{width:100%;border-collapse:collapse;margin-top:15px;}
table th,table td{padding:12px;text-align:left;border-bottom:1px solid #eee;font-size:14px;}
table tr:nth-child(even){background:#fafafa;}
table tr:hover{background:#f1f1f1;}
.dashboard-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin-bottom:30px;}
.dashboard-card{text-align:center;background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);transition:0.3s;}
.dashboard-card:hover{transform:translateY(-3px);}
.dashboard-card h3{font-size:20px;margin-bottom:10px;}
.dashboard-card p{font-size:16px;color:#555;}
#chartDiv{background:var(--card-bg);padding:20px;border-radius:12px;box-shadow:0 4px 10px rgba(0,0,0,0.05);margin-bottom:25px;}
.action-btn{margin-right:5px;cursor:pointer;color:var(--primary);}
.action-btn:hover{color:var(--primary-dark);}
.success{display:none;padding:10px;border-radius:8px;margin-bottom:15px;background:var(--success);color:var(--success-text);}
@media(max-width:768px){
  nav{width:60px;padding:20px 5px;}
  nav h1{display:none;}
  nav button{font-size:12px;gap:5px;padding:10px;}
  main{margin-left:60px;padding:15px;}
}
</style>
</head>
<body>

<nav>
<h1><i class="fas fa-church"></i> Catequese</h1>
<button onclick="showSection('dashboard')" id="btn-dashboard" class="active"><i class="fas fa-tachometer-alt"></i> Dashboard</button>
<button onclick="showSection('turmas')" id="btn-turmas"><i class="fas fa-users"></i> Turmas</button>
<button onclick="showSection('catequizandos')" id="btn-catequizandos"><i class="fas fa-user-graduate"></i> Catequizandos</button>
<button onclick="showSection('presencas')" id="btn-presencas"><i class="fas fa-check-circle"></i> Presenças</button>
<button onclick="showSection('ritos')" id="btn-ritos"><i class="fas fa-cross"></i> Ritos</button>
</nav>

<main>
<!-- DASHBOARD -->
<section id="dashboard" class="active">
<h2>Dashboard</h2>
<div class="dashboard-cards">
<div class="dashboard-card"><h3 id="totalTurmas">0</h3><p>Turmas</p></div>
<div class="dashboard-card"><h3 id="totalCatequizandos">0</h3><p>Catequizandos</p></div>
<div class="dashboard-card"><h3 id="totalPresencas">0</h3><p>Presenças</p></div>
<div class="dashboard-card"><h3 id="totalRitos">0</h3><p>Ritos</p></div>
</div>
<div id="chartDiv"><canvas id="catequizandosChart"></canvas></div>
</section>

<!-- TURMAS -->
<section id="turmas">
<h2>Cadastro de Turmas</h2>
<div class="card">
<div class="form-group"><label>Nome</label><input type="text" id="turma_nome"></div>
<div class="form-group"><label>Catequista</label><input type="text" id="turma_catequista"></div>
<div class="form-group"><label>Horário</label><input type="text" id="turma_horario"></div>
<input type="hidden" id="turma_row">
<button class="btn" onclick="salvarTurma()">Salvar</button>
<div id="msgTurma" class="success">Turma salva com sucesso!</div>
</div>
<div class="card">
<h3>Lista de Turmas</h3>
<table id="lista_turmas">
<thead><tr><th>Nome</th><th>Catequista</th><th>Horário</th><th>Ações</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<!-- CATEQUIZANDOS -->
<section id="catequizandos">
<h2>Cadastro de Catequizandos</h2>
<div class="card">
<div class="form-group"><label>Nome do Catequizando</label><input type="text" id="cat_nome"></div>
<div class="form-group"><label>Data de Nascimento</label><input type="date" id="cat_data_nasc" onchange="calcularIdade()"></div>
<div class="form-group"><label>Idade</label><input type="text" id="cat_idade" readonly></div>
<div class="form-group"><label>Turma</label><select id="cat_turma"></select></div>
<div class="form-group"><label>Nome do Responsável</label><input type="text" id="cat_responsavel"></div>
<div class="form-group"><label>Contato do Responsável</label><input type="text" id="cat_contato_responsavel"></div>
<div class="form-group"><label>Observações</label><textarea id="cat_observacao" rows="3"></textarea></div>
<input type="hidden" id="cat_row">
<button class="btn" onclick="salvarCatequizando()">Salvar</button>
</div>
<div class="card">
<h3>Lista de Catequizandos</h3>
<table id="lista_catequizandos">
<thead><tr><th>Nome</th><th>Nascimento</th><th>Idade</th><th>Turma</th><th>Responsável</th><th>Contato</th><th>Observações</th><th>Ações</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<!-- PRESENÇAS -->
<section id="presencas">
<h2>Registro de Presenças</h2>
<div class="card">
<div class="form-group"><label>Turma</label><select id="pres_turma" onchange="carregarCatequizandosPresenca()"></select></div>
<div class="form-group"><label>Data</label><input type="date" id="pres_data"></div>
</div>
<div class="card" id="lista_presencas"></div>
</section>

<!-- RITOS -->
<section id="ritos">
<h2>Registro de Ritos</h2>
<div class="card">
<div class="form-group"><label>Turma</label><select id="rito_turma" onchange="carregarCatequizandosRitoPorTurma()"></select></div>
<div class="form-group"><label>Catequizando</label><select id="rito_cat"></select></div>
<div class="form-group"><label>Tipo de Rito</label><input type="text" id="rito_tipo"></div>
<div class="form-group"><label>Data</label><input type="date" id="rito_data"></div>
<input type="hidden" id="rito_row">
<button class="btn" onclick="salvarRito()">Salvar</button>
</div>
<div class="card">
<h3>Lista de Ritos</h3>
<table id="lista_ritos">
<thead><tr><th>Catequizando</th><th>Turma</th><th>Tipo</th><th>Data</th><th>Ações</th></tr></thead>
<tbody></tbody>
</table>
</div>
</section>

<script>
const API_URL = "https://sheetdb.io/api/v1/a7deww2pd3giv";

// Navegação
function showSection(id){
  document.querySelectorAll("section").forEach(s=>s.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  document.querySelectorAll("nav button").forEach(btn=>btn.classList.remove("active"));
  document.getElementById("btn-"+id).classList.add("active");
}

// Calcular idade
function calcularIdade(){
  const input = document.getElementById('cat_data_nasc').value;
  if(!input) return;
  const hoje = new Date();
  const nasc = new Date(input);
  let idade = hoje.getFullYear() - nasc.getFullYear();
  const m = hoje.getMonth() - nasc.getMonth();
  if(m < 0 || (m === 0 && hoje.getDate() < nasc.getDate())) idade--;
  document.getElementById('cat_idade').value = idade;
}

// ---------------- FUNÇÕES DASHBOARD ----------------
async function carregarDashboard(){
  const turmas=await (await fetch(`${API_URL}?sheet=Turmas`)).json();
  const catequizandos=await (await fetch(`${API_URL}?sheet=Catequizandos`)).json();
  const presencas=await (await fetch(`${API_URL}?sheet=Presencas`)).json();
  const ritos=await (await fetch(`${API_URL}?sheet=Ritos`)).json();

  document.getElementById('totalTurmas').textContent=turmas.length;
  document.getElementById('totalCatequizandos').textContent=catequizandos.length;
  document.getElementById('totalPresencas').textContent=presencas.length;
  document.getElementById('totalRitos').textContent=ritos.length;

  // Gráfico Catequizandos por Turma
  const ctx=document.getElementById('catequizandosChart').getContext('2d');
  const labels=[...new Set(catequizandos.map(c=>c.turma))];
  const data=labels.map(l=>catequizandos.filter(c=>c.turma===l).length);
  if(window.myChart)window.myChart.destroy();
  window.myChart=new Chart(ctx,{type:'bar',data:{labels,datasets:[{label:'Catequizandos',data,backgroundColor:'#4CAF50'}]},options:{responsive:true}});

  preencherTurmas(); carregarCatequizandos(); preencherCatequizandosRito(); carregarRitos();
}

// ---------------- FUNÇÕES TURMAS ----------------
async function preencherTurmas(){
  const turmas=await (await fetch(`${API_URL}?sheet=Turmas`)).json();
  const tbody=document.querySelector('#lista_turmas tbody'); tbody.innerHTML='';
  const selectCat=document.getElementById('cat_turma');
  const selectPres=document.getElementById('pres_turma');
  const selectRito=document.getElementById('rito_turma');
  tbody.innerHTML=''; selectCat.innerHTML=''; selectPres.innerHTML=''; selectRito.innerHTML='';
  turmas.forEach(t=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${t.nome}</td><td>${t.catequista}</td><td>${t.horario}</td>
      <td><i class='fas fa-edit action-btn' onclick='editarTurma(${JSON.stringify(t)})'></i>
          <i class='fas fa-trash action-btn' onclick='excluirTurma("${t.row}")'></i></td>`;
    tbody.appendChild(tr);
    selectCat.innerHTML+=`<option value='${t.nome}'>${t.nome}</option>`;
    selectPres.innerHTML+=`<option value='${t.nome}'>${t.nome}</option>`;
    selectRito.innerHTML+=`<option value='${t.nome}'>${t.nome}</option>`;
  });
}

async function salvarTurma(){
  const nome=document.getElementById('turma_nome').value;
  const catequista=document.getElementById('turma_catequista').value;
  const horario=document.getElementById('turma_horario').value;
  const row=document.getElementById('turma_row').value;
  const data={data:{nome,catequista,horario}};
  if(row){
    await fetch(`${API_URL}/${row}?sheet=Turmas`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  }else{
    await fetch(`${API_URL}?sheet=Turmas`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});
  }
  document.getElementById('turma_nome').value='';document.getElementById('turma_catequista').value='';document.getElementById('turma_horario').value='';document.getElementById('turma_row').value='';
  carregarDashboard();
}

function editarTurma(t){
  document.getElementById('turma_nome').value=t.nome;
  document.getElementById('turma_catequista').value=t.catequista;
  document.getElementById('turma_horario').value=t.horario;
  document.getElementById('turma_row').value=t.row;
}

async function excluirTurma(row){
  if(confirm('Deseja realmente excluir esta turma?')){
    await fetch(`${API_URL}/${row}?sheet=Turmas`,{method:'DELETE'});
    carregarDashboard();
  }
}

// ---------------- FUNÇÕES CATEQUIZANDOS ----------------
async function carregarCatequizandos(){
  const catequizandos=await (await fetch(`${API_URL}?sheet=Catequizandos`)).json();
  const tbody=document.querySelector('#lista_catequizandos tbody'); tbody.innerHTML='';
  catequizandos.forEach(c=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${c.nome}</td><td>${c.data_nasc}</td><td>${c.idade}</td><td>${c.turma}</td><td>${c.responsavel}</td><td>${c.contato_responsavel}</td><td>${c.observacao}</td>
      <td><i class='fas fa-edit action-btn' onclick='editarCatequizando(${JSON.stringify(c)})'></i>
          <i class='fas fa-trash action-btn' onclick='excluirCatequizando("${c.row}")'></i></td>`;
    tbody.appendChild(tr);
  });
}

function editarCatequizando(c){
  document.getElementById('cat_nome').value=c.nome;
  document.getElementById('cat_data_nasc').value=c.data_nasc;
  document.getElementById('cat_idade').value=c.idade;
  document.getElementById('cat_turma').value=c.turma;
  document.getElementById('cat_responsavel').value=c.responsavel;
  document.getElementById('cat_contato_responsavel').value=c.contato_responsavel;
  document.getElementById('cat_observacao').value=c.observacao;
  document.getElementById('cat_row').value=c.row;
}

async function excluirCatequizando(row){
  if(confirm('Deseja realmente excluir este catequizando?')){
    await fetch(`${API_URL}/${row}?sheet=Catequizandos`,{method:'DELETE'});
    carregarDashboard();
  }
}

async function salvarCatequizando(){
  const nome=document.getElementById('cat_nome').value;
  const data_nasc=document.getElementById('cat_data_nasc').value;
  const idade=document.getElementById('cat_idade').value;
  const turma=document.getElementById('cat_turma').value;
  const responsavel=document.getElementById('cat_responsavel').value;
  const contato_responsavel=document.getElementById('cat_contato_responsavel').value;
  const observacao=document.getElementById('cat_observacao').value;
  const row=document.getElementById('cat_row').value;

  const data={data:{nome,data_nasc,idade,turma,responsavel,contato_responsavel,observacao}};

  if(row){
    await fetch(`${API_URL}/${row}?sheet=Catequizandos`,{
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
  }else{
    await fetch(`${API_URL}?sheet=Catequizandos`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify(data)
    });
  }

  // Limpar campos
  document.getElementById('cat_nome').value='';
  document.getElementById('cat_data_nasc').value='';
  document.getElementById('cat_idade').value='';
  document.getElementById('cat_turma').value='';
  document.getElementById('cat_responsavel').value='';
  document.getElementById('cat_contato_responsavel').value='';
  document.getElementById('cat_observacao').value='';
  document.getElementById('cat_row').value='';

  carregarDashboard();
}

// ---------------- FUNÇÕES PRESENÇAS ----------------
async function carregarCatequizandosPresenca(){
  const turma=document.getElementById('pres_turma').value;
  const catequizandos=await (await fetch(`${API_URL}?sheet=Catequizandos`)).json();
  const lista=catequizandos.filter(c=>c.turma===turma);
  const div=document.getElementById('lista_presencas'); div.innerHTML='';
  lista.forEach(c=>{
    const checked = c.presenca==='Sim'?'checked':'';
    div.innerHTML+=`<div style="margin-bottom:8px;">
      <input type="checkbox" data-row="${c.row}" ${checked} onchange="marcarPresenca(this)"/> ${c.nome}
    </div>`;
  });
}

async function marcarPresenca(checkbox){
  const row=checkbox.getAttribute('data-row');
  const presenca=checkbox.checked?'Sim':'Não';
  await fetch(`${API_URL}/${row}?sheet=Catequizandos`,{
    method:'PUT',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify({data:{presenca}})
  });
  carregarDashboard();
}

// ---------------- FUNÇÕES RITOS ----------------
async function preencherCatequizandosRito(){
  const turma=document.getElementById('rito_turma').value;
  if(!turma) return;
  const catequizandos=await (await fetch(`${API_URL}?sheet=Catequizandos`)).json();
  const select=document.getElementById('rito_cat'); select.innerHTML='';
  catequizandos.filter(c=>c.turma===turma).forEach(c=>{
    select.innerHTML+=`<option value="${c.nome}">${c.nome}</option>`;
  });
}

async function carregarCatequizandosRitoPorTurma(){
  preencherCatequizandosRito();
}

async function carregarRitos(){
  const ritos=await (await fetch(`${API_URL}?sheet=Ritos`)).json();
  const tbody=document.querySelector('#lista_ritos tbody'); tbody.innerHTML='';
  ritos.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${r.catequizando}</td><td>${r.turma}</td><td>${r.tipo}</td><td>${r.data}</td>
      <td><i class='fas fa-trash action-btn' onclick='excluirRito("${r.row}")'></i></td>`;
    tbody.appendChild(tr);
  });
}

async function salvarRito(){
  const turma=document.getElementById('rito_turma').value;
  const catequizando=document.getElementById('rito_cat').value;
  const tipo=document.getElementById('rito_tipo').value;
  const data=document.getElementById('rito_data').value;
  const row=document.getElementById('rito_row').value;
  const dados={data:{turma,catequizando,tipo,data}};
  if(row){
    await fetch(`${API_URL}/${row}?sheet=Ritos`,{method:'PUT',headers:{'Content-Type':'application/json'},body:JSON.stringify(dados)});
  }else{
    await fetch(`${API_URL}?sheet=Ritos`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(dados)});
  }
  document.getElementById('rito_tipo').value='';
  document.getElementById('rito_data').value='';
  document.getElementById('rito_row').value='';
  carregarDashboard();
}

async function excluirRito(row){
  if(confirm('Deseja realmente excluir este rito?')){
    await fetch(`${API_URL}/${row}?sheet=Ritos`,{method:'DELETE'});
    carregarDashboard();
  }
}

// Inicialização
window.onload=carregarDashboard;
</script>
</main>
</body>
</html>
