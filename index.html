<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Sistema Catequese</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    body { font-family: Arial, sans-serif; margin:0; padding:0; background:#f4f4f4;}
    header { background:#4CAF50; color:#fff; padding:10px 20px; text-align:center; }
    h1 { margin:0; }
    .container { padding:20px; max-width:1200px; margin:auto; }
    button { cursor:pointer; padding:8px 12px; border:none; border-radius:4px; background:#4CAF50; color:#fff; margin:2px; }
    button:hover { background:#45a049; }
    table { width:100%; border-collapse:collapse; margin:10px 0;}
    th, td { border:1px solid #ddd; padding:8px; text-align:left;}
    th { background:#4CAF50; color:white; }
    select, input { padding:6px; margin:4px 0; width:100%; box-sizing:border-box; }
    .modal { display:none; position:fixed; z-index:1; left:0; top:0; width:100%; height:100%; overflow:auto; background:rgba(0,0,0,0.5); }
    .modal-content { background:#fff; margin:10% auto; padding:20px; border-radius:8px; width:90%; max-width:600px; }
    .close { color:#aaa; float:right; font-size:28px; font-weight:bold; }
    .close:hover { color:#000; cursor:pointer; }
    @media(max-width:768px){ table, th, td { font-size:12px; } }
</style>
</head>
<body>

<header>
    <h1>Sistema de Catequese</h1>
</header>

<div class="container">
    <h2>Dashboard</h2>
    <div id="dashboard">
        <p>Total de Turmas: <span id="totalTurmas">0</span></p>
        <p>Total de Catequizandos: <span id="totalCatequizandos">0</span></p>
        <p>Total de Ritos Aplicados: <span id="totalRitos">0</span></p>
    </div>

    <hr>

    <h2>Cadastro de Turmas</h2>
    <input type="text" id="nomeTurma" placeholder="Nome da Turma">
    <button onclick="cadastrarTurma()">Cadastrar Turma</button>
    <table id="tabelaTurmas">
        <thead><tr><th>Turma</th><th>Ações</th></tr></thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Cadastro de Ritos</h2>
    <input type="text" id="nomeRito" placeholder="Nome do Rito">
    <select id="ritoTurma"><option value="">Selecione a Turma</option></select>
    <button onclick="cadastrarRito()">Cadastrar Rito</button>
    <table id="tabelaRitos">
        <thead><tr><th>Rito</th><th>Turma</th><th>Ações</th></tr></thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Cadastro de Catequizandos</h2>
    <input type="text" id="nomeCatequizando" placeholder="Nome do Catequizando">
    <input type="text" id="responsavel" placeholder="Responsável">
    <input type="text" id="contatoResponsavel" placeholder="Contato do Responsável">
    <input type="date" id="dataNascimento" placeholder="Data de Nascimento">
    <select id="turmaCatequizando"><option value="">Selecione a Turma</option></select>
    <textarea id="observacao" placeholder="Observação"></textarea>
    <button onclick="cadastrarCatequizando()">Cadastrar Catequizando</button>
    <table id="tabelaCatequizandos">
        <thead><tr><th>Nome</th><th>Idade</th><th>Turma</th><th>Responsável</th><th>Contato</th><th>Observação</th><th>Ações</th></tr></thead>
        <tbody></tbody>
    </table>

    <hr>

    <h2>Registro de Presença</h2>
    <select id="turmaPresenca"><option value="">Selecione a Turma</option></select>
    <table id="tabelaPresenca">
        <thead><tr><th>Catequizando</th><th>Presente</th></tr></thead>
        <tbody></tbody>
    </table>
    <button onclick="salvarPresenca()">Salvar Presença</button>

    <hr>

    <h2>Relatórios</h2>
    <select id="relatorioTurma"><option value="">Selecione a Turma</option></select>
    <button onclick="gerarRelatorio()">Visualizar Relatório</button>
    <button onclick="exportarPDF()">Exportar PDF</button>
    <button onclick="exportarExcel()">Exportar Excel</button>
    <div id="relatorioContainer"></div>
</div>

<!-- Modal -->
<div id="modal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="fecharModal()">&times;</span>
    <h2>Editar Catequizando</h2>
    <input type="hidden" id="idEditar">
    <input type="text" id="nomeEditar">
    <input type="text" id="responsavelEditar">
    <input type="text" id="contatoEditar">
    <input type="date" id="dataEditar">
    <select id="turmaEditar"><option value="">Selecione a Turma</option></select>
    <textarea id="observacaoEditar"></textarea>
    <button onclick="salvarEdicao()">Salvar Alterações</button>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
const API = "https://sheetdb.io/api/v1/a7deww2pd3giv";
let turmas=[], ritos=[], catequizandos=[];

// Função auxiliar para calcular idade
function calcularIdade(dataNasc){
    const hoje = new Date();
    const nasc = new Date(dataNasc);
    let idade = hoje.getFullYear() - nasc.getFullYear();
    const m = hoje.getMonth() - nasc.getMonth();
    if(m<0 || (m===0 && hoje.getDate()<nasc.getDate())) idade--;
    return idade;
}

// Dashboard
function atualizarDashboard(){
    document.getElementById("totalTurmas").innerText = turmas.length;
    document.getElementById("totalCatequizandos").innerText = catequizandos.length;
    document.getElementById("totalRitos").innerText = ritos.length;
}

// CARREGAR DADOS
async function carregarDados(){
    const res = await fetch(API);
    const data = await res.json();
    // separar dados por aba
    turmas = data.filter(d => d.sheet==="Turmas");
    ritos = data.filter(d => d.sheet==="Ritos");
    catequizandos = data.filter(d => d.sheet==="Catequizandos");
    atualizarDashboard();
    preencherTabelas();
}
carregarDados();

// PREENCHE TABELAS
function preencherTabelas(){
    const tabelaTurmas = document.querySelector("#tabelaTurmas tbody");
    const tabelaRitos = document.querySelector("#tabelaRitos tbody");
    const tabelaCate = document.querySelector("#tabelaCatequizandos tbody");
    tabelaTurmas.innerHTML=""; tabelaRitos.innerHTML=""; tabelaCate.innerHTML="";

    turmas.forEach(t=>{
        tabelaTurmas.innerHTML += `<tr><td>${t.nome}</td><td><button onclick="excluirTurma('${t.id}')">Excluir</button></td></tr>`;
    });
    ritos.forEach(r=>{
        tabelaRitos.innerHTML += `<tr><td>${r.nome}</td><td>${r.turma}</td><td><button onclick="excluirRito('${r.id}')">Excluir</button></td></tr>`;
    });
    catequizandos.forEach(c=>{
        tabelaCate.innerHTML += `<tr>
            <td>${c.nome}</td>
            <td>${calcularIdade(c.data)}</td>
            <td>${c.turma}</td>
            <td>${c.responsavel}</td>
            <td>${c.contato}</td>
            <td>${c.observacao}</td>
            <td><button onclick="abrirModal('${c.id}')">Editar</button></td>
        </tr>`;
    });

    // preencher selects
    const turmaSelects = ["turmaCatequizando","turmaEditar","ritoTurma","turmaPresenca","relatorioTurma"];
    turmaSelects.forEach(id=>{
        const sel = document.getElementById(id);
        sel.innerHTML = '<option value="">Selecione a Turma</option>';
        turmas.forEach(t=>{
            sel.innerHTML += `<option value="${t.nome}">${t.nome}</option>`;
        });
    });

    // tabela presença
    atualizarTabelaPresenca();
}

// ATUALIZAR TABELA PRESENÇA
function atualizarTabelaPresenca(){
    const turma = document.getElementById("turmaPresenca").value;
    const tabela = document.querySelector("#tabelaPresenca tbody");
    tabela.innerHTML="";
    catequizandos.filter(c=>c.turma===turma).forEach(c=>{
        tabela.innerHTML += `<tr>
            <td>${c.nome}</td>
            <td><input type="checkbox" data-id="${c.id}"></td>
        </tr>`;
    });
}
document.getElementById("turmaPresenca").addEventListener("change", atualizarTabelaPresenca);

// CADASTROS
async function cadastrarTurma(){
    const nome = document.getElementById("nomeTurma").value;
    if(!nome) return alert("Informe o nome da turma");
    await fetch(API, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data:{sheet:"Turmas",nome}})});
    document.getElementById("nomeTurma").value="";
    carregarDados();
}

async function cadastrarRito(){
    const nome = document.getElementById("nomeRito").value;
    const turma = document.getElementById("ritoTurma").value;
    if(!nome || !turma) return alert("Preencha todos os campos");
    await fetch(API, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data:{sheet:"Ritos",nome,turma}})});
    document.getElementById("nomeRito").value="";
    carregarDados();
}

async function cadastrarCatequizando(){
    const nome = document.getElementById("nomeCatequizando").value;
    const responsavel = document.getElementById("responsavel").value;
    const contato = document.getElementById("contatoResponsavel").value;
    const data = document.getElementById("dataNascimento").value;
    const turma = document.getElementById("turmaCatequizando").value;
    const observacao = document.getElementById("observacao").value;
    if(!nome || !turma) return alert("Preencha todos os campos obrigatórios");
    await fetch(API, {method:"POST", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data:{sheet:"Catequizandos",nome,responsavel,contato,data,turma,observacao}})});
    document.getElementById("nomeCatequizando").value="";
    document.getElementById("responsavel").value="";
    document.getElementById("contatoResponsavel").value="";
    document.getElementById("dataNascimento").value="";
    document.getElementById("turmaCatequizando").value="";
    document.getElementById("observacao").value="";
    carregarDados();
}

// MODAL
function abrirModal(id){
    const c = catequizandos.find(x=>x.id===id);
    document.getElementById("idEditar").value = c.id;
    document.getElementById("nomeEditar").value = c.nome;
    document.getElementById("responsavelEditar").value = c.responsavel;
    document.getElementById("contatoEditar").value = c.contato;
    document.getElementById("dataEditar").value = c.data;
    document.getElementById("turmaEditar").value = c.turma;
    document.getElementById("observacaoEditar").value = c.observacao;
    document.getElementById("modal").style.display = "block";
}
function fecharModal(){ document.getElementById("modal").style.display="none"; }
async function salvarEdicao(){
    const id = document.getElementById("idEditar").value;
    const nome = document.getElementById("nomeEditar").value;
    const responsavel = document.getElementById("responsavelEditar").value;
    const contato = document.getElementById("contatoEditar").value;
    const data = document.getElementById("dataEditar").value;
    const turma = document.getElementById("turmaEditar").value;
    const observacao = document.getElementById("observacaoEditar").value;
    await fetch(`${API}/id/${id}`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data:{nome,responsavel,contato,data,turma,observacao}})});
    fecharModal();
    carregarDados();
}

// EXCLUIR
async function excluirTurma(id){ await fetch(`${API}/id/${id}`, {method:"DELETE"}); carregarDados(); }
async function excluirRito(id){ await fetch(`${API}/id/${id}`, {method:"DELETE"}); carregarDados(); }

// PRESENÇA
async function salvarPresenca(){
    const checkboxes = document.querySelectorAll("#tabelaPresenca input[type=checkbox]");
    checkboxes.forEach(async cb=>{
        const id = cb.dataset.id;
        await fetch(`${API}/id/${id}`, {method:"PUT", headers:{"Content-Type":"application/json"}, body:JSON.stringify({data:{presente:cb.checked?"Sim":"Não"}})});
    });
    alert("Presenças salvas!");
    carregarDados();
}

// RELATÓRIOS
function gerarRelatorio(){
    const turma = document.getElementById("relatorioTurma").value;
    const lista = catequizandos.filter(c=>c.turma===turma);
    let html = `<h3>Relatório da Turma: ${turma}</h3><table border="1"><tr><th>Nome</th><th>Idade</th><th>Ritos</th><th>Presença</th></tr>`;
    lista.forEach(c=>{
        const ritosCate = ritos.filter(r=>r.turma===turma).map(r=>r.nome).join(", ");
        html += `<tr>
            <td>${c.nome}</td>
            <td>${calcularIdade(c.data)}</td>
            <td>${ritosCate}</td>
            <td>${c.presente || ""}</td>
        </tr>`;
    });
    html += "</table>";
    document.getElementById("relatorioContainer").innerHTML = html;
}

// EXPORTAR PDF
function exportarPDF(){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.html(document.getElementById("relatorioContainer"), {callback:function(pdf){ pdf.save("relatorio.pdf"); }});
}

// EXPORTAR EXCEL
function exportarExcel(){
    const table = document.querySelector("#relatorioContainer table");
    const wb = XLSX.utils.table_to_book(table, {sheet:"Relatório"});
    XLSX.writeFile(wb,"relatorio.xlsx");
}
</script>

</body>
</html>
